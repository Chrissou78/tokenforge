<!DOCTYPE html>
<!-- TokenForge Pro v3.0 - FULLY INTEGRATED - 23 CONTRACTS - 2024-12-28 -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Creator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Ensure disconnect button starts hidden */
        #disconnectBtnHeader {
            display: none !important;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #0a0e1a;
            color: white;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 { color: #00d4ff; margin-bottom: 0.5rem; }
        .subtitle { color: #8892b0; margin-bottom: 2rem; }
        
        .section {
            background: #121826;
            border: 2px solid #1f2937;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            background: #0a0e1a;
            border: 2px solid #1f2937;
            color: white;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-size: 1rem;
            font-family: inherit;
        }
        
        textarea {
            min-height: 300px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }
        
        button {
            width: 100%;
            padding: 1rem;
            background: #00d4ff;
            color: #0a0e1a;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 0.5rem 0;
            transition: all 0.3s;
        }
        
        button:hover:not(:disabled) { 
            background: #0099cc;
            transform: translateY(-2px);
        }
        
        button:disabled { 
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary { background: #4a90e2; }
        .btn-secondary:hover:not(:disabled) { background: #357abd; }
        
        .info-box {
            background: #0a0e1a;
            border-left: 4px solid #00d4ff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .warning-box {
            background: #2d1f15;
            border-left: 4px solid #ffaa00;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            color: #ffcc88;
        }
        
        .success-box {
            background: #1a2d2d;
            border-left: 4px solid #00d4ff;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            color: #aae3ff;
        }
        
        .template-card {
            background: #0a0e1a;
            border: 2px solid #1f2937;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .template-card:hover {
            border-color: #00d4ff;
            transform: translateY(-2px);
        }
        
        .template-card.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }
        
        .template-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        /* CONTRACT VARIANT SELECTION - RADIO BUTTONS */
        .contract-variant {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #0a0e1a;
            border: 2px solid #1f2937;
            border-radius: 8px;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .contract-variant:hover {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }
        
        .contract-variant.selected {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }
        
        .radio-button {
            width: 24px;
            height: 24px;
            border: 2px solid #1f2937;
            border-radius: 50%;
            margin-right: 1rem;
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .contract-variant:hover .radio-button {
            border-color: #00d4ff;
        }
        
        .contract-variant.selected .radio-button {
            border-color: #00d4ff;
        }
        
        .radio-button.checked::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #00d4ff;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat {
            background: #0a0e1a;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #1f2937;
        }
        
        .stat-label {
            color: #8892b0;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            color: #00d4ff;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: monospace;
        }
        
        .wallet-status {
            background: #0a0e1a;
            border: 2px solid #1f2937;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .wallet-status.connected {
            border-color: #00d4ff;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            gap: 1rem;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 1rem;
            background: #0a0e1a;
            border: 2px solid #1f2937;
            border-radius: 8px;
        }
        
        .step.active {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }
        
        .step.completed {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.05);
        }
        
        .hidden { display: none; }
        
        label {
            display: block;
            color: #8892b0;
            margin: 1rem 0 0.5rem 0;
            font-weight: bold;
        }
        
        .code-preview {
            background: #0a0e1a;
            border: 2px solid #1f2937;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script src="CONTRACT_BYTECODES.js"></script>
    <script>
        // Define functions in head so onclick handlers work
        // Full implementations are below in main script
        var web3;
        var userAccount;
        
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    web3 = new Web3(window.ethereum);
                    
                    document.getElementById('walletAddressHeader').textContent = 
                        userAccount.substring(0, 6) + '...' + userAccount.substring(38);
                    document.getElementById('connectBtnHeader').style.display = 'none';
                    document.getElementById('disconnectBtnHeader').style.display = 'block';
                    
                    console.log('Wallet connected:', userAccount);
                } catch (error) {
                    console.error('Wallet connection failed:', error);
                    alert('Failed to connect wallet: ' + error.message);
                }
            } else {
                alert('Please install MetaMask!');
            }
        }
        
        function disconnectWallet() {
            userAccount = null;
            document.getElementById('walletAddressHeader').textContent = 'Not Connected';
            document.getElementById('connectBtnHeader').style.display = 'block';
            document.getElementById('disconnectBtnHeader').style.display = 'none';
            console.log('Wallet disconnected');
        }
    </script>
<body>
    <h1>ü™ô Token Creator</h1>
    <p class="subtitle">Create and deploy custom ERC20 tokens with advanced features</p>
    

    <!-- Wallet Status -->
    <div style="background: #121826; border: 2px solid #1f2937; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="color: #8892b0; font-size: 0.85rem;">Wallet Status</div>
                <div id="walletAddressHeader" style="color: #00d4ff; font-size: 1.1rem; font-weight: bold; margin-top: 0.3rem;">Not Connected</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button id="connectBtnHeader" onclick="connectWallet()" style="padding: 0.8rem 1.5rem; background: #00d4ff; color: #0a0e1a; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Connect Wallet
                </button>
                <button id="disconnectBtnHeader" onclick="disconnectWallet()" style="padding: 0.8rem 1.5rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Disconnect
                </button>
            </div>
        </div>
    </div>

    <!-- EVM Only Notice -->
    <div style="background: rgba(0, 212, 255, 0.1); border: 2px solid #00d4ff; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
            <div>
                <strong style="color: #00d4ff;">EVM Chains Only</strong>
                <div style="color: #8892b0; font-size: 0.85rem; margin-top: 0.25rem;">
                    Token Creator supports EVM-compatible blockchains (Ethereum, BSC, Polygon, Arbitrum, etc.)
                    ‚Ä¢ Solana/Sui token creation coming soon
                </div>
            </div>
        </div>
    </div>
    
    <!-- Step 1: Template Selection -->
    <div class="section" id="templateSection">
        <h3>1Ô∏è‚É£ Choose Token Template</h3>
        
    <!-- Chain Selector -->
    <div class="section" style="background: #121826; border: 2px solid #1f2937; border-radius: 12px; padding: 1.5rem; margin: 2rem 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <div style="color: #8892b0; font-size: 0.85rem; margin-bottom: 0.5rem;">Active Blockchain</div>
                <div style="color: #00d4ff; font-size: 1.2rem; font-weight: bold;" id="activeChainDisplay">Ethereum</div>
            </div>
            <button onclick="openChainModal()" style="padding: 0.8rem 1.5rem; background: #00d4ff; color: #0a0e1a; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                Change Chain
            </button>
        </div>
        <div style="color: #8892b0; font-size: 0.85rem; text-align: center; margin-top: 1rem;">
            Chain synced across all tools ‚Ä¢ 33 blockchains supported
        </div>
    </div>

        <div class="grid-3">
            <div class="template-card active" data-template="standard">
                <div class="template-icon">ü™ô</div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Standard</div>
                <div style="color: #8892b0; font-size: 0.85rem;">
                    Basic ERC20 token<br>
                    Simple & reliable
                </div>
            </div>
            
            <div class="template-card" data-template="mintable">
                <div class="template-icon">‚ûï</div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Mintable</div>
                <div style="color: #8892b0; font-size: 0.85rem;">
                    Create new tokens<br>
                    Owner can mint
                </div>
            </div>
            
            
            <div class="template-card" data-template="tax">
                <div class="template-icon">üí∞</div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Tax Token</div>
                <div style="color: #8892b0; font-size: 0.85rem;">
                    Auto tax on transfers<br>
                    Buy/sell fees
                </div>
            </div>
            
            <div class="template-card" data-template="reflection">
                <div class="template-icon">üíé</div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Reflection</div>
                <div style="color: #8892b0; font-size: 0.85rem;">
                    Holder rewards<br>
                    Passive income
                </div>
            </div>
            
            <div class="template-card" data-template="advanced">
                <div class="template-icon">‚ö°</div>
                <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">Advanced</div>
                <div style="color: #8892b0; font-size: 0.85rem;">
                    All features<br>
                    Fully customizable
                </div>
            </div>
        </div>
        
        <button onclick="nextStep(2)" style="margin-top: 2rem;">Continue ‚Üí</button>
    </div>
    
    <!-- Step 2: Token Details -->
    <div class="section hidden" id="detailsSection">
        <h3>2Ô∏è‚É£ Token Details</h3>
        
        <!-- Chain Display (no button) -->
        <div style="background: #121826; border: 2px solid #1f2937; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="color: #8892b0; font-size: 0.85rem;">Deploying to:</div>
            <div style="color: #00d4ff; font-size: 1.1rem; font-weight: bold; margin-top: 0.3rem;" id="activeChainDisplay2">Ethereum</div>
        </div>
        
        <div class="grid-2">
            <div>
                <label>Token Name</label>
                <input type="text" id="tokenName" placeholder="My Awesome Token">
            </div>
            
            <div>
                <label>Token Symbol</label>
                <input type="text" id="tokenSymbol" placeholder="MAT" style="text-transform: uppercase;">
            </div>
        </div>
        
        <label>Initial Supply</label>
        <input type="number" id="initialSupply" placeholder="1000000000">
        
        <label>Decimals</label>
        <select id="decimals">
            <option value="18">18 (Standard - like ETH)</option>
            <option value="9">9 (Common for meme tokens)</option>
            <option value="6">6 (Like USDC)</option>
            <option value="8">8 (Like Bitcoin)</option>
        </select>
        
        <!-- Tax Token Parameters (hidden by default) -->
        <div id="taxParameters" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #1a1f2e; border: 2px solid #00d4ff; border-radius: 8px;">
            <h4 style="color: #00d4ff; margin-bottom: 1rem;">üí∞ Tax Settings</h4>
            
            <label>Tax Rate (%)</label>
            <input type="number" id="taxRate" placeholder="3" min="0" max="25" step="0.1" value="3">
            <p style="font-size: 0.85rem; color: #8892b0; margin-top: 0.5rem;">Percentage of each transaction taken as tax (max 25%)</p>
            
            <label style="margin-top: 1rem;">Tax Recipient Address</label>
            <input type="text" id="taxRecipient" placeholder="0x... (leave empty to use your wallet)">
            <p style="font-size: 0.85rem; color: #8892b0; margin-top: 0.5rem;">Where tax funds will be sent (defaults to deployer)</p>
        </div>
        
        <!-- Reflection Token Parameters (hidden by default) -->
        <div id="reflectionParameters" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #1a1f2e; border: 2px solid #00d4ff; border-radius: 8px;">
            <h4 style="color: #00d4ff; margin-bottom: 1rem;">‚ú® Reflection Settings</h4>
            
            <label>Reflection Fee (%)</label>
            <input type="number" id="reflectionFee" placeholder="2" min="0" max="10" step="0.1" value="2">
            <p style="font-size: 0.85rem; color: #8892b0; margin-top: 0.5rem;">Percentage redistributed to all holders (max 10%)</p>
        </div>
        
        <!-- Mintable Cap Parameters (hidden by default) -->
        <div id="mintableCapParameters" style="display: none; margin-top: 1.5rem; padding: 1.5rem; background: #1a1f2e; border: 2px solid #00d4ff; border-radius: 8px;">
            <h4 style="color: #00d4ff; margin-bottom: 1rem;">üîí Mintable Supply Cap</h4>
            
            <label>Maximum Total Supply Cap (optional)</label>
            <input type="number" id="mintableCap" placeholder="Leave empty for 2x initial supply">
            <p style="font-size: 0.85rem; color: #8892b0; margin-top: 0.5rem;">
                <strong>Only for Capped/Full variants:</strong> Sets the maximum total supply that can ever exist after minting.<br>
                ‚Ä¢ Defaults to 2x your initial supply if left empty<br>
                ‚Ä¢ Must be ‚â• initial supply<br>
                ‚Ä¢ Example: Initial supply 1,000,000 ‚Üí Default cap 2,000,000
            </p>
        </div>
        
        <div class="grid-2" style="margin-top: 2rem;">
            <button onclick="prevStep(1)" class="btn-secondary">‚Üê Back</button>
            <button onclick="nextStep(3)">Continue ‚Üí</button>
        </div>
    </div>
    
    <!-- Step 3: Features -->
    <div class="section hidden" id="featuresSection">
        <h3>3Ô∏è‚É£ Select Features</h3>
        
        <!-- Chain Display (no button) -->
        <div style="background: #121826; border: 2px solid #1f2937; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="color: #8892b0; font-size: 0.85rem;">Deploying to:</div>
            <div style="color: #00d4ff; font-size: 1.1rem; font-weight: bold; margin-top: 0.3rem;" id="activeChainDisplay3">Ethereum</div>
        </div>
        
        <div id="featuresList">
            <!-- Features will be populated based on template -->
        </div>
        
        <div class="grid-2" style="margin-top: 2rem;">
            <button onclick="prevStep(2)" class="btn-secondary">‚Üê Back</button>
            <button onclick="nextStep(4)">Continue ‚Üí</button>
        </div>
    </div>
    
    <!-- Step 4: Review -->
    <div class="section hidden" id="reviewSection">
        <h3>4Ô∏è‚É£ Review Your Token</h3>
        
        <!-- Chain Display (no button) -->
        <div style="background: #121826; border: 2px solid #1f2937; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
            <div style="color: #8892b0; font-size: 0.85rem;">Deploying to:</div>
            <div style="color: #00d4ff; font-size: 1.1rem; font-weight: bold; margin-top: 0.3rem;" id="activeChainDisplay4">Ethereum</div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Template</div>
                <div class="stat-value" id="reviewTemplate">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Token Name</div>
                <div class="stat-value" id="reviewName" style="font-size: 1rem;">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Symbol</div>
                <div class="stat-value" id="reviewSymbol">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Supply</div>
                <div class="stat-value" id="reviewSupply" style="font-size: 1rem;">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Decimals</div>
                <div class="stat-value" id="reviewDecimals">-</div>
            </div>
        </div>
        
        <label>Contract Source Code</label>
        <div class="code-preview" id="contractPreview">
            // Contract will be generated here...
        </div>
        
        <div class="info-box">
            <strong>Features Included:</strong>
            <div id="reviewFeatures" style="margin-top: 0.5rem;"></div>
        </div>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è Before Deploying:</strong><br>
            ‚Ä¢ Review all parameters carefully<br>
            ‚Ä¢ Ensure you have gas for deployment<br>
            ‚Ä¢ Contract will be immutable<br>
            ‚Ä¢ Test on testnet first
        </div>
        
        <div class="grid-2" style="margin-top: 2rem;">
            <button onclick="prevStep(3)" class="btn-secondary">‚Üê Back</button>
            <button onclick="nextStep(5)">Deploy Contract ‚Üí</button>
        </div>
    </div>
    
    <!-- Step 5: Deploy -->
    <div class="section hidden" id="deploySection">
        <h3>5Ô∏è‚É£ Deploy Token</h3>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Network</div>
                <div class="stat-value" id="deployNetwork" style="font-size: 1rem;">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Est. Gas</div>
                <div class="stat-value" id="deployGas">~$0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Status</div>
                <div class="stat-value" id="deployStatus" style="font-size: 1rem;">Ready</div>
            </div>
        </div>
        
        <div id="deployProgress" class="hidden">
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                <div style="color: #00d4ff; font-size: 1.2rem; margin-bottom: 0.5rem;">Deploying Contract...</div>
                <div style="color: #8892b0;" id="deployStep">Compiling contract...</div>
            </div>
        </div>
        
        <button id="deployBtn" onclick="deployToken()">üöÄ Deploy Token Contract</button>
    </div>
    
    <!-- Success -->
    <div class="section hidden" id="successSection">
        <h3>üéâ Token Deployed Successfully!</h3>
        
        <div class="success-box">
            <strong>Contract Address:</strong><br>
            <span id="contractAddress" style="font-family: monospace; word-break: break-all; font-size: 1.1rem;">-</span>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Token Name</div>
                <div class="stat-value" id="successName" style="font-size: 1rem;">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Symbol</div>
                <div class="stat-value" id="successSymbol">-</div>
            </div>
            <div class="stat">
                <div class="stat-label">Supply</div>
                <div class="stat-value" id="successSupply" style="font-size: 1rem;">-</div>
            </div>
        </div>
        
        <div class="info-box">
            <strong>‚úÖ Next Steps:</strong><br>
            ‚Ä¢ Verify contract on block explorer<br>
            ‚Ä¢ Add liquidity on DEX<br>
            ‚Ä¢ Update token info on trackers<br>
            ‚Ä¢ Distribute to holders
        </div>
        
        <div class="grid-2">
            <button onclick="viewOnExplorer()" class="btn-secondary">üîç View on Explorer</button>
            <button onclick="createAnother()">ü™ô Create Another Token</button>
        </div>
    </div>
    
    <!-- Info -->
    <div class="section">
        <h3>üìã Token Templates Guide</h3>
        
        <div class="info-box">
            <strong>ü™ô Standard:</strong> Basic ERC20 with fixed supply. Simple and gas-efficient.
        </div>
        
        <div class="info-box">
            <strong>‚ûï Mintable:</strong> Owner can create new tokens. Good for gradual distribution.
        </div>
        
        <div class="info-box">
            <strong>üî• Burnable:</strong> Reduce total supply by burning tokens. Deflationary model.
        </div>
        
        <div class="info-box">
            <strong>üí∞ Tax Token:</strong> Automatic tax on transfers. Configurable buy/sell fees.
        </div>
        
        <div class="info-box">
            <strong>üíé Reflection:</strong> Holders earn passive rewards. Percentage of transactions distributed.
        </div>
        
        <div class="info-box">
            <strong>‚ö° Advanced:</strong> All features combined. Maximum flexibility and control.
        </div>
    </div>

    <script>
        console.log('üöÄ Token Creator Script Loading...');
        console.log('Script started at:', new Date().toISOString());
        
        // === TOKEN CREATOR CODE ===
        let connected = false;
        let currentAccount = null;
        let currentStep = 1;
        let selectedTemplate = 'standard';
        let tokenConfig = {};
        
        async function connectWallet() {
            console.log('=== CONNECT WALLET CALLED ===');
            console.log('window.ethereum exists:', typeof window.ethereum !== 'undefined');
            
            if (typeof window.ethereum !== 'undefined') {
                try {
                    console.log('Requesting accounts from MetaMask...');
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    
                    console.log('Accounts received:', accounts);
                    
                    currentAccount = accounts[0];
                    connected = true;
                    
                    console.log('currentAccount set to:', currentAccount);
                    console.log('connected set to:', connected);
                    
                    // Store in localStorage
                    localStorage.setItem('connectedWallet', currentAccount);
                    localStorage.setItem('walletConnected', 'true');
                    localStorage.removeItem('userDisconnected'); // Clear disconnect flag
                    console.log('Saved to localStorage');
                    
                    updateWalletDisplay();
                    
                    document.getElementById('stepIndicator').classList.remove('hidden');
                    document.getElementById('templateSection').classList.remove('hidden');
                    console.log('Showed template section');
                    
                    alert('‚úÖ Wallet connected! Select a token template to begin.');
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    alert('Failed to connect wallet: ' + error.message);
                }
            } else {
                console.error('MetaMask not found!');
                alert('Please install MetaMask!');
            }
        }
        
        function disconnectWallet() {
            console.log('=== DISCONNECT WALLET CALLED ===');
            
            // Clear wallet state
            currentAccount = null;
            connected = false;
            
            // Clear localStorage
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('walletConnected');
            localStorage.setItem('userDisconnected', 'true'); // Flag to prevent auto-reconnect
            console.log('Cleared localStorage');
            
            // Reset UI
            const walletAddrHeader = document.getElementById('walletAddressHeader');
            if (walletAddrHeader) {
                walletAddrHeader.textContent = 'Not Connected';
            }
            
            const connectBtnHeader = document.getElementById('connectBtnHeader');
            if (connectBtnHeader) {
                connectBtnHeader.style.setProperty('display', 'block', 'important');
            }
            
            const disconnectBtnHeader = document.getElementById('disconnectBtnHeader');
            if (disconnectBtnHeader) {
                disconnectBtnHeader.style.setProperty('display', 'none', 'important');
            }
            
            const walletStatus = document.getElementById('walletStatus');
            if (walletStatus) {
                walletStatus.classList.remove('connected');
            }
            
            // Hide sections
            document.getElementById('stepIndicator').classList.add('hidden');
            document.getElementById('templateSection').classList.add('hidden');
            
            console.log('‚úÖ Wallet disconnected');
            alert('Wallet disconnected');
        }
        
        // Update wallet display in UI
        function updateWalletDisplay() {
            console.log('=== UPDATE WALLET DISPLAY ===');
            console.log('currentAccount:', currentAccount);
            
            if (!currentAccount) {
                console.log('No currentAccount, skipping update');
                return;
            }
            
            const shortAddress = currentAccount.substring(0, 6) + '...' + currentAccount.substring(38);
            console.log('shortAddress:', shortAddress);
            
            // Update all wallet displays
            const walletAddr = document.getElementById('walletAddress');
            if (walletAddr) {
                walletAddr.textContent = shortAddress;
                console.log('Updated walletAddress');
            } else {
                console.log('walletAddress element not found');
            }
            
            const walletAddrHeader = document.getElementById('walletAddressHeader');
            if (walletAddrHeader) {
                walletAddrHeader.textContent = shortAddress;
                console.log('Updated walletAddressHeader');
            } else {
                console.log('walletAddressHeader element not found');
            }
            
            const connectBtnHeader = document.getElementById('connectBtnHeader');
            if (connectBtnHeader) {
                connectBtnHeader.style.setProperty('display', 'none', 'important');
                console.log('Hidden connectBtnHeader');
            } else {
                console.log('connectBtnHeader element not found');
            }
            
            const disconnectBtnHeader = document.getElementById('disconnectBtnHeader');
            if (disconnectBtnHeader) {
                disconnectBtnHeader.style.setProperty('display', 'block', 'important');
                console.log('Shown disconnectBtnHeader');
            } else {
                console.log('disconnectBtnHeader element not found');
            }
            
            const walletStatus = document.getElementById('walletStatus');
            if (walletStatus) {
                walletStatus.classList.add('connected');
                console.log('Updated walletStatus');
            }
            
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn) {
                connectBtn.textContent = 'Connected ‚úì';
                connectBtn.disabled = true;
                connectBtn.style.background = '#10b981';
                console.log('Updated connectBtn');
            }
            
            console.log('‚úÖ Wallet display updated:', shortAddress);
        }
        
        function selectTemplate(template, element) {
            console.log('=== SELECT TEMPLATE CALLED ===');
            console.log('Template:', template);
            console.log('Element:', element);
            
            // Update selected template
            selectedTemplate = template;
            console.log('selectedTemplate updated to:', selectedTemplate);
            
            // Remove active from all
            const allCards = document.querySelectorAll('.template-card');
            console.log('Found', allCards.length, 'template cards');
            
            allCards.forEach(card => {
                card.classList.remove('active');
            });
            console.log('Removed active class from all cards');
            
            // Add active to this one
            if (element) {
                element.classList.add('active');
                console.log('Added active class to clicked card');
            } else {
                console.error('ERROR: element is null!');
            }
            
            // Show/hide parameter sections based on template
            updateParameterVisibility();
            
            console.log('=== TEMPLATE SELECTION COMPLETE ===');
        }
        
        function updateParameterVisibility() {
            console.log('=== UPDATE PARAMETER VISIBILITY ===');
            console.log('Selected template:', selectedTemplate);
            console.log('Selected contract variant:', window.selectedContractVariant);
            
            const taxParams = document.getElementById('taxParameters');
            const reflectionParams = document.getElementById('reflectionParameters');
            const mintableCapParams = document.getElementById('mintableCapParameters');
            
            console.log('Tax params element:', taxParams ? 'Found' : 'NOT FOUND');
            console.log('Reflection params element:', reflectionParams ? 'Found' : 'NOT FOUND');
            console.log('Mintable cap params element:', mintableCapParams ? 'Found' : 'NOT FOUND');
            
            // Hide all by default
            if (taxParams) {
                taxParams.style.display = 'none';
                console.log('Hidden tax parameters');
            }
            if (reflectionParams) {
                reflectionParams.style.display = 'none';
                console.log('Hidden reflection parameters');
            }
            if (mintableCapParams) {
                mintableCapParams.style.display = 'none';
                console.log('Hidden mintable cap parameters');
            }
            
            // Show relevant sections based on template
            if (selectedTemplate === 'tax' && taxParams) {
                taxParams.style.display = 'block';
                console.log('‚úÖ SHOWING TAX PARAMETERS');
                console.log('Tax rate field:', document.getElementById('taxRate') ? 'Found' : 'NOT FOUND');
                console.log('Tax recipient field:', document.getElementById('taxRecipient') ? 'Found' : 'NOT FOUND');
            } else if (selectedTemplate === 'reflection' && reflectionParams) {
                reflectionParams.style.display = 'block';
                console.log('‚úÖ SHOWING REFLECTION PARAMETERS');
                console.log('Reflection fee field:', document.getElementById('reflectionFee') ? 'Found' : 'NOT FOUND');
            } else if (selectedTemplate === 'mintable' && mintableCapParams) {
                // Show cap field for all mintable tokens (only used by Capped/Full variants)
                mintableCapParams.style.display = 'block';
                console.log('‚úÖ SHOWING MINTABLE CAP PARAMETERS');
                console.log('Mintable cap field:', document.getElementById('mintableCap') ? 'Found' : 'NOT FOUND');
            } else {
                console.log('No special parameters needed for template:', selectedTemplate);
            }
            
            console.log('=== PARAMETER VISIBILITY UPDATE COMPLETE ===');
        }
        
        function updateAllChainDisplays() {
            const chain = currentChain || 'Ethereum';
            const displayName = CHAIN_NAMES[chain] || chain;
            
            // Update all chain displays
            const displays = ['activeChainDisplay', 'activeChainDisplay2', 'activeChainDisplay3', 'activeChainDisplay4'];
            displays.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = displayName;
                }
            });
            
            console.log('Updated all chain displays to:', displayName);
        }
        
        function nextStep(step) {
            console.log('=== NEXT STEP CALLED ===');
            console.log('Requested step:', step);
            console.log('Current step:', currentStep);
            console.log('Selected template:', selectedTemplate);
            
            if (step === 2) {
                console.log('‚Üí Validating template selection for step 2');
                // Step 1 ‚Üí 2: Validate template selection
                if (!selectedTemplate) {
                    console.error('ERROR: No template selected!');
                    alert('Please select a token template!');
                    return;
                }
                console.log('‚úÖ Template validated:', selectedTemplate);
                
                // Show/hide parameter fields based on template
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => {
                    updateParameterVisibility();
                }, 100);
                
            } else if (step === 3) {
                console.log('‚Üí Validating token details for step 3');
                // Step 2 ‚Üí 3: Validate token details
                const name = document.getElementById('tokenName').value;
                const symbol = document.getElementById('tokenSymbol').value;
                const supply = document.getElementById('initialSupply').value;
                
                console.log('Name:', name, 'Symbol:', symbol, 'Supply:', supply);
                
                if (!name || !symbol || !supply) {
                    console.error('ERROR: Missing required fields');
                    alert('Please fill all required fields!\nName, Symbol, and Initial Supply are required.');
                    return;
                }
                
                tokenConfig = {
                    template: selectedTemplate,
                    name,
                    symbol,
                    supply,
                    decimals: document.getElementById('decimals').value
                };
                console.log('‚úÖ Token config created:', tokenConfig);
                
                // Call showFeatures to populate the features list
                showFeatures();
                console.log('‚úÖ Features populated for template:', selectedTemplate);
                
            } else if (step === 4) {
                console.log('‚Üí Moving to review step');
                showReview();
            } else if (step === 5) {
                console.log('‚Üí Moving to deploy step');
                showDeploy();
            }
            
            // Update current step
            console.log('Setting current step to:', step);
            currentStep = step;
            
            // Hide all sections
            console.log('Hiding all sections...');
            document.querySelectorAll('.section').forEach(s => {
                if (s.id && s.id.includes('Section')) {
                    s.classList.add('hidden');
                    console.log('  Hidden:', s.id);
                }
            });
            
            // Show current section
            const sections = ['', 'templateSection', 'detailsSection', 'featuresSection', 'reviewSection', 'deploySection'];
            const targetSection = sections[step];
            console.log('Showing section:', targetSection);
            
            if (targetSection) {
                const sectionEl = document.getElementById(targetSection);
                if (sectionEl) {
                    sectionEl.classList.remove('hidden');
                    console.log('‚úÖ Section visible:', targetSection);
                    console.log('Section element:', sectionEl);
                } else {
                    console.error('‚ùå ERROR: Section not found:', targetSection);
                }
            } else {
                console.error('‚ùå ERROR: No section defined for step', step);
            }
            
            // Update chain displays on all pages
            updateAllChainDisplays();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('=== NEXT STEP COMPLETE ===');
            console.log('');
        }
        
        function prevStep(step) {
            console.log('=== PREV STEP CALLED ===');
            console.log('Going back to step:', step);
            console.log('Current step:', currentStep);
            
            // Update current step
            currentStep = step;
            
            // Hide all sections
            console.log('Hiding all sections...');
            document.querySelectorAll('.section').forEach(s => {
                if (s.id && s.id.includes('Section')) {
                    s.classList.add('hidden');
                }
            });
            
            // Show target section
            const sections = ['', 'templateSection', 'detailsSection', 'featuresSection', 'reviewSection'];
            const targetSection = sections[step];
            console.log('Showing section:', targetSection);
            
            if (targetSection) {
                const sectionEl = document.getElementById(targetSection);
                if (sectionEl) {
                    sectionEl.classList.remove('hidden');
                    console.log('‚úÖ Section visible:', targetSection);
                } else {
                    console.error('‚ùå ERROR: Section not found:', targetSection);
                }
            }
            
            // Update chain displays
            updateAllChainDisplays();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('=== PREV STEP COMPLETE ===');
        }
        
        function markStepCompleted(step) {
            document.getElementById(`step${step}`).classList.add('completed');
            document.getElementById(`step${step}`).classList.remove('active');
        }
        
        function showFeatures() {
            // ‚úÖ CONTRACT VARIANTS - EACH IS A UNIQUE CONTRACT (NOT COMBINABLE)
            const contractVariants = {
                standard: [
                    { name: 'Standard_Basic', desc: 'Pure ERC20 - no extra features' },
                    { name: 'Standard_Ownable', desc: 'Owner controls + transfer ownership' },
                    { name: 'Standard_Pausable', desc: 'Owner + Pause/Unpause transfers' },
                    { name: 'Standard_Burnable', desc: 'Holders can burn their tokens' },
                    { name: 'Standard_Ownable_Burnable', desc: 'Owner controls + Burn functionality' },
                    { name: 'Standard_Pausable_Burnable', desc: 'Owner + Pause + Burn (full control)' }
                ],
                mintable: [
                    { name: 'Mintable_OwnerOnly', desc: 'Only owner can mint new tokens' },
                    { name: 'Mintable_Public', desc: 'Anyone can mint (permissionless)' },
                    { name: 'Mintable_Capped', desc: 'Owner minting + supply cap limit' },
                    { name: 'Mintable_Pausable', desc: 'Owner minting + pause transfers' },
                    { name: 'Mintable_Full', desc: 'All features: Mint, Pause, Burn, Cap' }
                ],
                tax: [
                    { name: 'Tax_Basic', desc: 'Fixed tax rate on all transfers' },
                    { name: 'Tax_Adjustable', desc: 'Owner can adjust tax rate anytime' },
                    { name: 'Tax_Pausable', desc: 'Tax + owner can pause transfers' },
                    { name: 'Tax_Burnable', desc: 'Tax + holders can burn tokens' }
                ],
                reflection: [
                    { name: 'Reflection_Basic', desc: 'Auto rewards to all holders' },
                    { name: 'Reflection_Excludable', desc: 'Owner can exclude addresses from rewards' },
                    { name: 'Reflection_Pausable', desc: 'Reflection + pause transfers' }
                ],
                advanced: [
                    { name: 'Advanced_Full', desc: 'All features: Mint, Pause, Burn, Cap' },
                    { name: 'Advanced_DeFi', desc: 'DeFi optimized + blacklist functionality' },
                    { name: 'Advanced_Governance', desc: 'Voting power + delegation for DAOs' },
                    { name: 'Advanced_Vesting', desc: 'Built-in token vesting schedule' },
                    { name: 'Advanced_Snapshot', desc: 'Balance snapshots for governance/dividends' }
                ]
            };
            
            const list = document.getElementById('featuresList');
            list.innerHTML = '';
            
            const variants = contractVariants[selectedTemplate] || [];
            
            if (variants.length === 0) {
                list.innerHTML = '<div class="info-box">No variants available</div>';
                return;
            }
            
            // Add header
            const header = document.createElement('div');
            header.style.cssText = 'margin-bottom: 1rem; color: #8892b0; font-size: 0.9rem;';
            header.innerHTML = `<strong style="color: #00d4ff;">Select ONE contract variant:</strong> (${variants.length} options)`;
            list.appendChild(header);
            
            // Create radio buttons for each variant
            variants.forEach((variant, index) => {
                const option = document.createElement('div');
                option.className = 'contract-variant';
                if (index === 0) option.classList.add('selected'); // Select first by default
                
                option.innerHTML = `
                    <div class="radio-button ${index === 0 ? 'checked' : ''}"></div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #00d4ff; margin-bottom: 0.3rem;">${variant.name}</div>
                        <div style="color: #8892b0; font-size: 0.85rem;">${variant.desc}</div>
                    </div>
                `;
                
                // Click handler - exclusive selection
                option.addEventListener('click', function() {
                    // Deselect all
                    document.querySelectorAll('.contract-variant').forEach(v => {
                        v.classList.remove('selected');
                        v.querySelector('.radio-button').classList.remove('checked');
                    });
                    
                    // Select this one
                    this.classList.add('selected');
                    this.querySelector('.radio-button').classList.add('checked');
                    
                    console.log('Selected contract:', variant.name);
                    
                    // Store selection
                    window.selectedContractVariant = variant.name;
                });
                
                list.appendChild(option);
            });
            
            // Set default selection
            window.selectedContractVariant = variants[0].name;
        }
        
        function getFeatureDescription(feature) {
            // ‚úÖ CORRECTED DESCRIPTIONS - MATCHING 23 CONTRACTS
            const descriptions = {
                // Standard features
                'Ownable': 'Owner can transfer ownership and control the contract',
                'Pausable': 'Owner can pause/unpause all transfers (emergency stop)',
                'Burnable': 'Token holders can permanently burn their tokens',
                
                // Mintable features
                'Owner-Only Minting': 'Only the contract owner can create new tokens',
                'Public Minting': 'Anyone can create new tokens (permissionless)',
                'Capped Supply': 'Maximum total supply limit (prevents minting beyond cap)',
                
                // Tax features
                'Fixed Tax Rate': 'Tax rate is set at deployment and cannot be changed',
                'Adjustable Tax Rate': 'Owner can update the tax rate after deployment',
                
                // Reflection features
                'Basic Reflection': 'Automatic rewards distributed to all token holders',
                'Excludable from Rewards': 'Owner can exclude specific addresses from receiving rewards',
                
                // Advanced features
                'Full Featured': 'All features: Ownable, Pausable, Mintable, Burnable, Capped',
                'DeFi Optimized': 'Built for DeFi with minting, burning, pausing, and blacklist',
                'Governance': 'Voting power and delegation for DAO governance',
                'Vesting Schedule': 'Built-in token vesting with time-based release',
                'Balance Snapshots': 'Take balance snapshots for dividends or governance'
            };
            return descriptions[feature] || 'Advanced feature';
        }
        
        function showReview() {
            document.getElementById('reviewName').textContent = tokenConfig.name;
            document.getElementById('reviewSymbol').textContent = tokenConfig.symbol;
            document.getElementById('reviewSupply').textContent = parseInt(tokenConfig.supply).toLocaleString();
            document.getElementById('reviewDecimals').textContent = tokenConfig.decimals;
            
            // Generate contract preview
            const contract = generateContract();
            document.getElementById('contractPreview').textContent = contract;
            
            // Show features
            const features = document.getElementById('reviewFeatures');
            const templateName = selectedTemplate.charAt(0).toUpperCase() + selectedTemplate.slice(1);
            features.innerHTML = `<strong>Template:</strong> ${templateName}<br><strong>Features:</strong> All standard ERC20 functions included`;
            
            // Update template display
            const reviewTemplate = document.getElementById('reviewTemplate');
            if (reviewTemplate) reviewTemplate.textContent = templateName;
        }
        
        function generateContract() {
            return `// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

contract ${tokenConfig.symbol} {
    string public name = "${tokenConfig.name}";
    string public symbol = "${tokenConfig.symbol}";
    uint8 public decimals = ${tokenConfig.decimals};
    uint256 public totalSupply = ${tokenConfig.supply} * 10**${tokenConfig.decimals};
    
    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    
    constructor() {
        balanceOf[msg.sender] = totalSupply;
        emit Transfer(address(0), msg.sender, totalSupply);
    }
    
    function transfer(address to, uint256 value) public returns (bool) {
        require(balanceOf[msg.sender] >= value, "Insufficient balance");
        balanceOf[msg.sender] -= value;
        balanceOf[to] += value;
        emit Transfer(msg.sender, to, value);
        return true;
    }
    
    function approve(address spender, uint256 value) public returns (bool) {
        allowance[msg.sender][spender] = value;
        emit Approval(msg.sender, spender, value);
        return true;
    }
    
    function transferFrom(address from, address to, uint256 value) public returns (bool) {
        require(balanceOf[from] >= value, "Insufficient balance");
        require(allowance[from][msg.sender] >= value, "Insufficient allowance");
        balanceOf[from] -= value;
        balanceOf[to] += value;
        allowance[from][msg.sender] -= value;
        emit Transfer(from, to, value);
        return true;
    }
}`;
        }
        
        function showDeploy() {
            const chain = currentChain || 'ethereum';
            const chainName = CHAIN_NAMES[chain] || chain;
            document.getElementById('deployNetwork').textContent = chainName;
            
            // Estimate gas based on template
            const gasEstimates = {
                'standard': 800000,
                'mintable': 1000000,
                'burnable': 850000,
                'tax': 1200000,
                'reflection': 1500000,
                'advanced': 2000000
            };
            
            const gasUnits = gasEstimates[selectedTemplate] || 800000;
            const gasPrice = 30; // gwei
            const ethPrice = 3000; // USD
            const gasCost = (gasUnits * gasPrice * ethPrice) / 1e9;
            
            document.getElementById('deployGas').textContent = '~$' + gasCost.toFixed(2) + ' (' + (gasUnits / 1000).toFixed(0) + 'k gas)';
            console.log('Deploy info updated:', chainName, gasCost);
        }
        
        function getConstructorArgs() {
            // ERC20 tokens need: name, symbol, decimals, totalSupply
            const name = tokenConfig.name;
            const symbol = tokenConfig.symbol;
            const decimals = parseInt(tokenConfig.decimals);
            
            // Validate inputs
            if (!name || name.trim() === '') {
                throw new Error('Token name cannot be empty');
            }
            if (!symbol || symbol.trim() === '') {
                throw new Error('Token symbol cannot be empty');
            }
            if (decimals < 0 || decimals > 18) {
                throw new Error('Decimals must be between 0 and 18');
            }
            if (!tokenConfig.supply || parseFloat(tokenConfig.supply) <= 0) {
                throw new Error('Token supply must be greater than 0');
            }
            
            // Convert supply to raw units
            const supplyWithDecimals = BigInt(tokenConfig.supply) * BigInt(10 ** decimals);
            const totalSupply = supplyWithDecimals.toString();
            
            // Get selected contract variant to determine constructor args
            const selectedContract = window.selectedContractVariant || 'Standard_Basic';
            
            console.log('‚úÖ Preparing constructor args for:', selectedContract);
            
            // Determine constructor signature based on contract type
            if (selectedContract.startsWith('Tax_')) {
                // Tax contracts need: (name, symbol, decimals, totalSupply, taxRate, taxRecipient)
                
                console.log('üîç Getting tax parameters from UI...');
                
                // Get tax rate from UI (default 3%)
                const taxRateInput = document.getElementById('taxRate');
                console.log('Tax rate input element:', taxRateInput ? 'Found' : 'NOT FOUND');
                console.log('Tax rate input value:', taxRateInput?.value);
                
                const taxRatePercent = parseFloat(taxRateInput?.value || '3');
                const taxRate = Math.floor(taxRatePercent * 100); // Convert % to basis points (3% = 300)
                
                console.log('Tax rate percent:', taxRatePercent);
                console.log('Tax rate basis points:', taxRate);
                
                // Get tax recipient from UI (default to deployer)
                const taxRecipientInput = document.getElementById('taxRecipient');
                console.log('Tax recipient input element:', taxRecipientInput ? 'Found' : 'NOT FOUND');
                console.log('Tax recipient input value:', taxRecipientInput?.value);
                
                let taxRecipient = taxRecipientInput?.value?.trim();
                if (!taxRecipient || taxRecipient === '') {
                    taxRecipient = currentAccount; // Default to deployer
                    console.log('Using deployer address as tax recipient:', taxRecipient);
                }
                
                // Validate tax rate
                if (taxRate < 0 || taxRate > 2500) {
                    throw new Error('Tax rate must be between 0% and 25%');
                }
                
                // Validate tax recipient address (basic check)
                if (!taxRecipient.match(/^0x[a-fA-F0-9]{40}$/)) {
                    throw new Error('Invalid tax recipient address format');
                }
                
                console.log('‚úÖ Tax contract args:', {
                    name, symbol, decimals, totalSupply,
                    taxRatePercent: taxRatePercent + '%',
                    taxRateBasisPoints: taxRate,
                    taxRecipient
                });
                
                return [name, symbol, decimals, totalSupply, taxRate, taxRecipient];
                
            } else if (selectedContract.startsWith('Reflection_')) {
                // Reflection contracts need: (name, symbol, decimals, totalSupply, reflectionFee)
                
                // Get reflection fee from UI (default 2%)
                const reflectionFeePercent = parseFloat(document.getElementById('reflectionFee')?.value || '2');
                const reflectionFee = Math.floor(reflectionFeePercent * 100); // Convert % to basis points
                
                // Validate reflection fee
                if (reflectionFee < 0 || reflectionFee > 1000) {
                    throw new Error('Reflection fee must be between 0% and 10%');
                }
                
                console.log('‚úÖ Reflection contract args:', {
                    name, symbol, decimals, totalSupply,
                    reflectionFeePercent: reflectionFeePercent + '%',
                    reflectionFeeBasisPoints: reflectionFee
                });
                
                return [name, symbol, decimals, totalSupply, reflectionFee];
                
            } else if (selectedContract === 'Mintable_Capped' || selectedContract === 'Mintable_Full') {
                // Mintable_Capped and Mintable_Full need: (name, symbol, decimals, totalSupply, cap)
                
                // Get cap from UI or use default (2x supply)
                const capInput = document.getElementById('mintableCap');
                let cap;
                
                if (capInput && capInput.value && parseFloat(capInput.value) > 0) {
                    // User provided a cap value
                    const capWithDecimals = BigInt(capInput.value) * BigInt(10 ** decimals);
                    cap = capWithDecimals.toString();
                    
                    // Validate cap is >= initial supply
                    if (BigInt(cap) < BigInt(totalSupply)) {
                        throw new Error('Maximum cap must be greater than or equal to initial supply');
                    }
                } else {
                    // Default: cap = 2x initial supply
                    cap = (BigInt(totalSupply) * BigInt(2)).toString();
                }
                
                console.log('‚úÖ Mintable Capped/Full contract args:', {
                    name, symbol, decimals, totalSupply, cap,
                    note: `Cap allows minting up to ${cap} tokens total`
                });
                
                return [name, symbol, decimals, totalSupply, cap];
                
            } else if (selectedContract === 'Advanced_Full' || selectedContract === 'Advanced_Vesting') {
                // Advanced contracts with 5 params
                // Use a default parameter value (e.g., 0 for no vesting, or a reasonable default)
                const extraParam = '0'; // Default value for 5th parameter
                
                console.log('‚úÖ Advanced contract args:', {
                    name, symbol, decimals, totalSupply, extraParam
                });
                
                return [name, symbol, decimals, totalSupply, extraParam];
                
            } else {
                // Standard, Most Mintable, Most Advanced - all use 4 params
                console.log('‚úÖ Standard contract args:', {
                    name, symbol, decimals, totalSupply
                });
                
                return [name, symbol, decimals, totalSupply];
            }
        }
        
        
        async function getContractBytecodeAndABI(template) {
            // Get bytecode from external CONTRACT_BYTECODES.js file  
            const selectedContract = window.selectedContractVariant || 'Standard_Basic';
            
            console.log('üìã Getting ABI for contract:', selectedContract);
            
            // Verify CONTRACT_BYTECODES is loaded
            if (typeof CONTRACT_BYTECODES === 'undefined') {
                throw new Error('CONTRACT_BYTECODES.js not loaded! Please ensure the script is included in the HTML.');
            }
            
            // Get the bytecode for the selected contract
            const bytecode = CONTRACT_BYTECODES[selectedContract];
            
            if (!bytecode) {
                throw new Error(`Bytecode not found for contract: ${selectedContract}`);
            }
            
            // Define constructor ABI based on contract type
            let constructorABI;
            
            if (selectedContract.startsWith('Tax_')) {
                // Tax contracts: 6 parameters (name, symbol, decimals, supply, taxRate, taxRecipient)
                console.log('üìã Using Tax contract ABI (6 params)');
                constructorABI = {
                    "inputs": [
                        {"internalType":"string","name":"_name","type":"string"},
                        {"internalType":"string","name":"_symbol","type":"string"},
                        {"internalType":"uint8","name":"_decimals","type":"uint8"},
                        {"internalType":"uint256","name":"_totalSupply","type":"uint256"},
                        {"internalType":"uint256","name":"_taxRate","type":"uint256"},
                        {"internalType":"address","name":"_taxRecipient","type":"address"}
                    ],
                    "stateMutability":"nonpayable",
                    "type":"constructor"
                };
            } else if (selectedContract.startsWith('Reflection_')) {
                // Reflection contracts: 5 parameters (name, symbol, decimals, supply, reflectionFee)
                console.log('üìã Using Reflection contract ABI (5 params)');
                constructorABI = {
                    "inputs": [
                        {"internalType":"string","name":"_name","type":"string"},
                        {"internalType":"string","name":"_symbol","type":"string"},
                        {"internalType":"uint8","name":"_decimals","type":"uint8"},
                        {"internalType":"uint256","name":"_totalSupply","type":"uint256"},
                        {"internalType":"uint256","name":"_reflectionFee","type":"uint256"}
                    ],
                    "stateMutability":"nonpayable",
                    "type":"constructor"
                };
            } else if (selectedContract === 'Mintable_Capped' || selectedContract === 'Mintable_Full') {
                // Mintable_Capped and Mintable_Full: 5 parameters (name, symbol, decimals, supply, cap)
                console.log('üìã Using Mintable Capped/Full contract ABI (5 params)');
                constructorABI = {
                    "inputs": [
                        {"internalType":"string","name":"_name","type":"string"},
                        {"internalType":"string","name":"_symbol","type":"string"},
                        {"internalType":"uint8","name":"_decimals","type":"uint8"},
                        {"internalType":"uint256","name":"_totalSupply","type":"uint256"},
                        {"internalType":"uint256","name":"_cap","type":"uint256"}
                    ],
                    "stateMutability":"nonpayable",
                    "type":"constructor"
                };
            } else if (selectedContract === 'Advanced_Full' || selectedContract === 'Advanced_Vesting') {
                // Advanced_Full and Advanced_Vesting: 5 parameters
                console.log('üìã Using Advanced contract ABI (5 params)');
                constructorABI = {
                    "inputs": [
                        {"internalType":"string","name":"_name","type":"string"},
                        {"internalType":"string","name":"_symbol","type":"string"},
                        {"internalType":"uint8","name":"_decimals","type":"uint8"},
                        {"internalType":"uint256","name":"_totalSupply","type":"uint256"},
                        {"internalType":"uint256","name":"_param","type":"uint256"}
                    ],
                    "stateMutability":"nonpayable",
                    "type":"constructor"
                };
            } else {
                // Standard/Most Mintable/Most Advanced: 4 parameters (name, symbol, decimals, supply)
                console.log('üìã Using Standard contract ABI (4 params)');
                constructorABI = {
                    "inputs": [
                        {"internalType":"string","name":"_name","type":"string"},
                        {"internalType":"string","name":"_symbol","type":"string"},
                        {"internalType":"uint8","name":"_decimals","type":"uint8"},
                        {"internalType":"uint256","name":"_totalSupply","type":"uint256"}
                    ],
                    "stateMutability":"nonpayable",
                    "type":"constructor"
                };
            }
            
            // Build complete ABI with the correct constructor
            const workingABI = [
                constructorABI,
                {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},
                {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},
                {"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
                {"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
                {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
                {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
                {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}
            ];
            
            console.log('‚úÖ ABI prepared with constructor params:', constructorABI.inputs.length);
            
            // Return the ABI and bytecode
            return {
                abi: workingABI,
                bytecode: bytecode
            };
        }
        
        function getChainId(chain) {
            const chainIds = {
                // Mainnets
                'ethereum': '0x1',        // 1
                'bsc': '0x38',            // 56
                'polygon': '0x89',        // 137
                'avalanche': '0xa86a',    // 43114
                'fantom': '0xfa',         // 250
                'arbitrum': '0xa4b1',     // 42161
                'optimism': '0xa',        // 10
                'base': '0x2105',         // 8453
                'gnosis': '0x64',         // 100
                'celo': '0xa4ec',         // 42220
                'moonbeam': '0x504',      // 1284
                'moonriver': '0x505',     // 1285
                'cronos': '0x19',         // 25
                'aurora': '0x4e454152',   // 1313161554
                'harmony': '0x63564c40',  // 1666600000
                'metis': '0x440',         // 1088
                'zksync': '0x144',        // 324
                'polygonzk': '0x44d',     // 1101
                'linea': '0xe708',        // 59144
                'scroll': '0x82750',      // 534352
                'mantle': '0x1388',       // 5000
                'blast': '0x13e31',       // 81457
                'opbnb': '0xcc',          // 204
                'canto': '0x1e14',        // 7700
                'kava': '0x8ae',          // 2222
                'evmos': '0x2329',        // 9001
                'klaytn': '0x2019',       // 8217
                'fuse': '0x7a',           // 122
                'telos': '0x28',          // 40
                'monad': '0x2711',        // 10001
                'berachain': '0x138d5',   // 80085
                
                // Testnets
                'sepolia': '0xaa36a7',           // 11155111
                'amoy': '0x13882',               // 80002
                'bsctest': '0x61',               // 97
                'arbitrumsepolia': '0x66eee',    // 421614
                'basesepolia': '0x14a34',        // 84532
                'optimismsepolia': '0xaa37dc'    // 11155420
            };
            
            return chainIds[chain] || null;
        }
        
        function getCreationFee(chain) {
            // These are fallback values if API fails
            // Will be replaced by real-time calculation
            const fallbackFees = {
                // Mainnets
                'ethereum': '0.15', 'bsc': '7.5', 'polygon': '500', 'avalanche': '15',
                'fantom': '1000', 'arbitrum': '0.15', 'optimism': '0.15', 'base': '0.15',
                'gnosis': '500', 'celo': '500', 'moonbeam': '250', 'moonriver': '250',
                'cronos': '2500', 'aurora': '0.15', 'harmony': '25000', 'metis': '10',
                'zksync': '0.15', 'polygonzk': '0.15', 'linea': '0.15', 'scroll': '0.15',
                'mantle': '200', 'blast': '0.15', 'opbnb': '7.5', 'canto': '1000',
                'kava': '500', 'evmos': '500', 'klaytn': '2000', 'fuse': '5000',
                'telos': '2500', 'monad': '0.15', 'berachain': '50',
                // Testnets
                'sepolia': '0.001', 'amoy': '0.01', 'bsctest': '0.01',
                'arbitrumsepolia': '0.001', 'basesepolia': '0.001', 'optimismsepolia': '0.001'
            };
            
            return fallbackFees[chain] || '0.1';
        }
        
        function getCoinGeckoId(chain) {
            // Map chain names to CoinGecko API IDs
            const coinGeckoIds = {
                'ethereum': 'ethereum',
                'bsc': 'binancecoin',
                'polygon': 'matic-network',
                'avalanche': 'avalanche-2',
                'fantom': 'fantom',
                'arbitrum': 'ethereum',
                'optimism': 'ethereum',
                'base': 'ethereum',
                'gnosis': 'xdai',
                'celo': 'celo',
                'moonbeam': 'moonbeam',
                'moonriver': 'moonriver',
                'cronos': 'crypto-com-chain',
                'aurora': 'ethereum',
                'harmony': 'harmony',
                'metis': 'metis-token',
                'zksync': 'ethereum',
                'polygonzk': 'ethereum',
                'linea': 'ethereum',
                'scroll': 'ethereum',
                'mantle': 'mantle',
                'blast': 'ethereum',
                'opbnb': 'binancecoin',
                'canto': 'canto',
                'kava': 'kava',
                'evmos': 'evmos',
                'klaytn': 'klay-token',
                'fuse': 'fuse-network-token',
                'telos': 'telos',
                'monad': 'ethereum', // Placeholder
                'berachain': 'ethereum', // Placeholder
                // Testnets use same as mainnets
                'sepolia': 'ethereum',
                'amoy': 'matic-network',
                'bsctest': 'binancecoin',
                'arbitrumsepolia': 'ethereum',
                'basesepolia': 'ethereum',
                'optimismsepolia': 'ethereum'
            };
            
            return coinGeckoIds[chain] || 'ethereum';
        }
        
        async function calculateCreationFeeInRealTime(chain, targetUSD = 500) {
            try {
                console.log(`üí∞ Fetching real-time price for ${chain}...`);
                
                // Get CoinGecko ID for this chain
                const coinId = getCoinGeckoId(chain);
                
                // Fetch current price from CoinGecko API (free, no key required)
                const response = await fetch(
                    `https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`
                );
                
                if (!response.ok) {
                    throw new Error('Price API failed');
                }
                
                const data = await response.json();
                const currentPriceUSD = data[coinId]?.usd;
                
                if (!currentPriceUSD || currentPriceUSD <= 0) {
                    throw new Error('Invalid price data');
                }
                
                console.log(`‚úÖ Current ${getNativeTokenSymbol(chain)} price: $${currentPriceUSD}`);
                
                // Calculate tokens needed for $500
                const tokensNeeded = targetUSD / currentPriceUSD;
                
                // Round UP to first decimal place (ensures we always get at least $500)
                const tokensRounded = Math.ceil(tokensNeeded * 10) / 10;
                
                console.log(`üíµ Fee calculation: $${targetUSD} / $${currentPriceUSD} = ${tokensNeeded.toFixed(4)}`);
                console.log(`‚úÖ Rounded fee: ${tokensRounded} ${getNativeTokenSymbol(chain)}`);
                
                return tokensRounded.toString();
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Real-time price fetch failed, using fallback:', error.message);
                
                // Use static fallback if API fails
                const fallbackFee = getCreationFee(chain);
                console.log(`üìä Using fallback fee: ${fallbackFee} ${getNativeTokenSymbol(chain)}`);
                
                return fallbackFee;
            }
        }
        
        function getNativeTokenSymbol(chain) {
            const symbols = {
                'ethereum': 'ETH', 'bsc': 'BNB', 'polygon': 'MATIC', 'avalanche': 'AVAX',
                'fantom': 'FTM', 'arbitrum': 'ETH', 'optimism': 'ETH', 'base': 'ETH',
                'gnosis': 'xDAI', 'celo': 'CELO', 'moonbeam': 'GLMR', 'moonriver': 'MOVR',
                'cronos': 'CRO', 'aurora': 'ETH', 'harmony': 'ONE', 'metis': 'METIS',
                'zksync': 'ETH', 'polygonzk': 'ETH', 'linea': 'ETH', 'scroll': 'ETH',
                'mantle': 'MNT', 'blast': 'ETH', 'opbnb': 'BNB', 'canto': 'CANTO',
                'kava': 'KAVA', 'evmos': 'EVMOS', 'klaytn': 'KLAY', 'fuse': 'FUSE',
                'telos': 'TLOS', 'monad': 'MONAD', 'berachain': 'BERA',
                'sepolia': 'ETH', 'amoy': 'MATIC', 'bsctest': 'BNB',
                'arbitrumsepolia': 'ETH', 'basesepolia': 'ETH', 'optimismsepolia': 'ETH'
            };
            return symbols[chain] || 'TOKEN';
        }
        
        function getCreationFeeRecipient() {
            // TODO: Replace with your actual fee collection address
            return '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'; // Placeholder - UPDATE THIS!
        }
        
        async function deployToken() {
            console.log('=== DEPLOY TOKEN (Web3.js) ===');
            
            if (!connected || !currentAccount) {
                alert('Please connect your wallet first!');
                return;
            }
            
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask!');
                return;
            }
            
            // Check if Web3 is loaded
            if (typeof Web3 === 'undefined') {
                alert('Web3.js not loaded. Please refresh the page.');
                return;
            }
            
            try {
                // Calculate creation fee in real-time
                const creationFeeAmount = await calculateCreationFeeInRealTime(currentChain, 500);
                const nativeTokenSymbol = getNativeTokenSymbol(currentChain);
                
                const confirmed = confirm(`Deploy ${tokenConfig.name} (${tokenConfig.symbol}) token?

Supply: ${parseInt(tokenConfig.supply).toLocaleString()}
Network: ${currentChain}

‚ö†Ô∏è CREATION FEE: ${creationFeeAmount} ${nativeTokenSymbol} (~$500 USD)
   Real-time price calculated

This will cost gas + creation fee. Continue?`);
                
                if (!confirmed) return;
                
                // Store fee amount for use in deployment
                window.calculatedCreationFee = creationFeeAmount;
                
            } catch (error) {
                console.error('Fee calculation error:', error);
                alert('Failed to calculate creation fee. Please try again.');
                return;
            }
            
            try {
                const deployBtn = document.getElementById('deployBtn');
                const deployProgress = document.getElementById('deployProgress');
                const deployStatus = document.getElementById('deployStatus');
                const deployStep = document.getElementById('deployStep');
                
                deployBtn.disabled = true;
                deployProgress.classList.remove('hidden');
                deployStatus.textContent = 'Starting...';
                deployStatus.style.color = '#ffaa00';
                
                // Initialize Web3
                deployStep.textContent = 'Initializing Web3...';
                const web3 = new Web3(window.ethereum);
                console.log('‚úÖ Web3 initialized');
                
                // Switch network
                deployStep.textContent = 'Switching network...';
                const targetChainId = getChainId(currentChain);
                if (targetChainId) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: targetChainId }]
                        });
                        console.log('‚úÖ Network switched');
                    } catch (err) {
                        console.error('Network switch failed:', err);
                        throw new Error('Failed to switch network. Please switch manually in MetaMask.');
                    }
                }
                
                // Get contract ABI and bytecode for selected template
                deployStep.textContent = 'Loading contract...';
                const { abi, bytecode } = await getContractBytecodeAndABI(selectedTemplate);
                
                console.log('Bytecode length:', bytecode.length);
                
                // Get constructor arguments
                const args = getConstructorArgs();
                console.log('Constructor args:', args);
                console.log('Args types:', args.map(a => typeof a));
                console.log('Bytecode type:', typeof bytecode);
                console.log('Bytecode starts with 0x:', bytecode.startsWith('0x'));
                console.log('Bytecode length:', bytecode.length);
                
                // Create contract instance
                deployStep.textContent = 'Creating contract instance...';
                const contract = new web3.eth.Contract(abi);
                
                // Prepare deployment transaction
                deployStep.textContent = 'Preparing deployment...';
                
                console.log('About to call contract.deploy() with:');
                console.log('  data:', bytecode.substring(0, 50) + '...');
                console.log('  arguments:', JSON.stringify(args));
                
                const deployTx = contract.deploy({
                    data: bytecode,
                    arguments: args
                });
                
                console.log('deployTx created successfully');
                console.log('deployTx type:', typeof deployTx);
                
                // Estimate gas
                deployStep.textContent = 'Estimating gas...';
                let gasEstimate;
                try {
                    console.log('Calling estimateGas with:', {
                        from: currentAccount,
                        data: bytecode,
                        arguments: args
                    });
                    gasEstimate = await deployTx.estimateGas({ from: currentAccount });
                    console.log('‚úÖ Gas estimate successful:', gasEstimate);
                } catch (gasError) {
                    console.error('‚ùå Gas estimation failed:', gasError);
                    console.error('Error message:', gasError.message);
                    console.error('Error data:', gasError.data);
                    
                    // Try to extract the revert reason
                    if (gasError.message) {
                        console.error('Full error:', JSON.stringify(gasError, null, 2));
                    }
                    
                    // Use a reasonable default
                    gasEstimate = 3000000; // 3M gas default
                    console.warn('Using default gas estimate:', gasEstimate);
                }
                
                // Deploy contract
                deployStep.textContent = 'Deploying contract...';
                deployStatus.textContent = 'Please confirm in MetaMask...';
                
                console.log('=== ABOUT TO DEPLOY ===');
                console.log('Current account:', currentAccount);
                console.log('Gas estimate:', gasEstimate);
                console.log('Gas to send:', Math.floor(gasEstimate * 1.5));
                
                // Get current network
                const chainId = await web3.eth.getChainId();
                console.log('Current chainId:', chainId);
                console.log('Expected chain:', currentChain);
                
                // Check balance
                const balance = await web3.eth.getBalance(currentAccount);
                console.log('Account balance:', web3.utils.fromWei(balance, 'ether'), 'ETH/MATIC');
                
                // Get current gas price
                const gasPrice = await web3.eth.getGasPrice();
                console.log('Current gas price:', gasPrice);
                
                // Send creation fee first (separate transaction)
                deployStep.textContent = 'Processing creation fee...';
                const creationFeeAmount = window.calculatedCreationFee || getCreationFee(currentChain);
                const creationFeeWei = web3.utils.toWei(creationFeeAmount, 'ether');
                const feeRecipient = getCreationFeeRecipient();
                
                console.log('üí∞ Sending creation fee:', creationFeeAmount, getNativeTokenSymbol(currentChain));
                console.log('Fee in wei:', creationFeeWei);
                console.log('Fee recipient:', feeRecipient);
                
                try {
                    const feeReceipt = await web3.eth.sendTransaction({
                        from: currentAccount,
                        to: feeRecipient,
                        value: creationFeeWei,
                        gas: 21000 // Standard ETH transfer
                    });
                    console.log('‚úÖ Creation fee sent:', feeReceipt.transactionHash);
                } catch (feeError) {
                    console.error('‚ùå Creation fee payment failed:', feeError);
                    throw new Error('Creation fee payment failed. Deployment cancelled.');
                }
                
                // Now deploy the contract
                deployStep.textContent = 'Deploying contract...';
                console.log('Sending deployment transaction...');
                const newContract = await deployTx.send({
                    from: currentAccount,
                    gas: Math.floor(gasEstimate * 1.5), // 50% buffer
                    gasPrice: gasPrice // Use current network gas price
                });
                
                const contractAddress = newContract.options.address;
                console.log('‚úÖ Contract deployed at:', contractAddress);
                
                // Success!
                deployStep.textContent = 'Deployment successful!';
                deployStatus.textContent = 'Token deployed!';
                deployStatus.style.color = '#00ff00';
                
                document.getElementById('contractAddress').textContent = contractAddress;
                document.getElementById('successName').textContent = tokenConfig.name;
                document.getElementById('successSymbol').textContent = tokenConfig.symbol;
                document.getElementById('successSupply').textContent = parseInt(tokenConfig.supply).toLocaleString();
                
                window.deployedContractAddress = contractAddress;
                
                document.getElementById('deploySection').classList.add('hidden');
                document.getElementById('successSection').classList.remove('hidden');
                
                alert('üéâ Token deployed successfully!\n\nContract Address:\n' + contractAddress);
                
            } catch (error) {
                console.error('Deployment error:', error);
                document.getElementById('deployStatus').textContent = 'Failed';
                document.getElementById('deployStatus').style.color = '#ff0000';
                document.getElementById('deployStep').textContent = error.message || 'Deployment failed';
                alert('Deployment failed:\n\n' + (error.message || 'Unknown error'));
            } finally {
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function viewOnExplorer() {
            const address = window.deployedContractAddress;
            const txHash = window.deployedTxHash;
            
            if (!address) {
                alert('No contract address available');
                return;
            }
            
            // Get explorer URL for current chain
            const explorerUrls = {
                // Mainnets
                'ethereum': 'https://etherscan.io',
                'polygon': 'https://polygonscan.com',
                'bsc': 'https://bscscan.com',
                'arbitrum': 'https://arbiscan.io',
                'optimism': 'https://optimistic.etherscan.io',
                'avalanche': 'https://snowtrace.io',
                'fantom': 'https://ftmscan.com',
                'cronos': 'https://cronoscan.com',
                'gnosis': 'https://gnosisscan.io',
                'base': 'https://basescan.org',
                'linea': 'https://lineascan.build',
                'scroll': 'https://scrollscan.com',
                'zksync': 'https://explorer.zksync.io',
                'polygonzkevm': 'https://zkevm.polygonscan.com',
                'mantle': 'https://explorer.mantle.xyz',
                'celo': 'https://celoscan.io',
                'aurora': 'https://aurorascan.dev',
                'moonbeam': 'https://moonscan.io',
                'moonriver': 'https://moonriver.moonscan.io',
                'harmony': 'https://explorer.harmony.one',
                'metis': 'https://andromeda-explorer.metis.io',
                'boba': 'https://bobascan.com',
                'monad': 'https://explorer.monad.xyz',
                'berachain': 'https://explorer.berachain.com',
                // Testnets
                'sepolia': 'https://sepolia.etherscan.io',
                'amoy': 'https://amoy.polygonscan.com',
                'bsctest': 'https://testnet.bscscan.com',
                'arbitrumsepolia': 'https://sepolia.arbiscan.io',
                'basesepolia': 'https://sepolia.basescan.org',
                'optimismsepolia': 'https://sepolia-optimism.etherscan.io'
            };
            
            const explorerUrl = explorerUrls[currentChain] || explorerUrls['ethereum'];
            const url = `${explorerUrl}/address/${address}`;
            
            console.log('Opening explorer:', url);
            window.open(url, '_blank');
        }
        
        function createAnother() {
            console.log('Creating another token...');
            
            // Reset to step 1
            currentStep = 1;
            selectedTemplate = 'standard';
            tokenConfig = {};
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => {
                if (s.id && s.id.includes('Section')) {
                    s.classList.add('hidden');
                }
            });
            
            // Show template section
            document.getElementById('templateSection').classList.remove('hidden');
            
            // Reset template selection
            document.querySelectorAll('.template-card').forEach(c => {
                c.classList.remove('active');
            });
            document.querySelector('[data-template="standard"]').classList.add('active');
            
            // Clear form fields
            document.getElementById('tokenName').value = '';
            document.getElementById('tokenSymbol').value = '';
            document.getElementById('initialSupply').value = '';
            document.getElementById('decimals').value = '18';
            
            // Reset deploy button
            document.getElementById('deployBtn').disabled = false;
            document.getElementById('deployProgress').classList.add('hidden');
            document.getElementById('deployStatus').textContent = 'Ready';
            document.getElementById('deployStatus').style.color = '#00d4ff';
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log('Reset complete!');
        }
        
        console.log('‚úÖ Token Creator Ready!');
        
        // Wait for ethers.js to load
        window.addEventListener('load', function() {
            if (typeof ethers !== 'undefined') {
                console.log('‚úÖ Ethers.js loaded successfully:', ethers.version);
            } else {
                console.error('‚ùå ERROR: Ethers.js failed to load!');
                console.log('Attempting to load ethers from alternative CDN...');
            }
        });
        
        // ===== EVENT LISTENERS =====
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== INITIALIZING TEMPLATE SELECTOR ===');
            
            // Check for wallet connection from index.html
            checkExistingWalletConnection();
            
            // Add click listeners to all template cards
            const templateCards = document.querySelectorAll('.template-card');
            console.log('Found', templateCards.length, 'template cards');
            
            templateCards.forEach((card, index) => {
                const template = card.getAttribute('data-template');
                console.log(`Card ${index}: ${template}`);
                
                card.addEventListener('click', function() {
                    console.log('=== TEMPLATE CARD CLICKED ===');
                    console.log('Template:', template);
                    
                    // Update selected template
                    selectedTemplate = template;
                    console.log('selectedTemplate =', selectedTemplate);
                    
                    // Remove active from all cards
                    templateCards.forEach(c => c.classList.remove('active'));
                    console.log('Removed active from all cards');
                    
                    // Add active to clicked card
                    this.classList.add('active');
                    console.log('Added active to clicked card');
                    console.log('=== SELECTION COMPLETE ===');
                });
            });
            
            console.log('‚úÖ Event listeners attached');
            console.log('=== INITIALIZATION COMPLETE ===');
        });
        
        // Check if wallet was connected in index.html
        function checkExistingWalletConnection() {
            const savedWallet = localStorage.getItem('connectedWallet');
            const wasConnected = localStorage.getItem('walletConnected');
            const userDisconnected = localStorage.getItem('userDisconnected');
            
            console.log('Checking for existing wallet connection...');
            console.log('savedWallet:', savedWallet);
            console.log('wasConnected:', wasConnected);
            console.log('userDisconnected:', userDisconnected);
            
            // Don't auto-reconnect if user explicitly disconnected
            if (userDisconnected === 'true') {
                console.log('User previously disconnected, not auto-reconnecting');
                return;
            }
            
            const connectBtn = document.getElementById('connectBtnHeader');
            const disconnectBtn = document.getElementById('disconnectBtnHeader');
            
            if (wasConnected === 'true' && savedWallet) {
                console.log('Found existing wallet connection:', savedWallet);
                
                // Set wallet state
                currentAccount = savedWallet;
                connected = true;
                
                // Update UI
                updateWalletDisplay();
                
                // Show template section
                const stepIndicator = document.getElementById('stepIndicator');
                if (stepIndicator) stepIndicator.classList.remove('hidden');
                
                const templateSection = document.getElementById('templateSection');
                if (templateSection) templateSection.classList.remove('hidden');
                
                console.log('‚úÖ Wallet auto-connected from localStorage');
            } else {
                console.log('No existing wallet connection found');
                
                // Ensure correct initial button state
                if (connectBtn) {
                    connectBtn.style.setProperty('display', 'block', 'important');
                }
                if (disconnectBtn) {
                    disconnectBtn.style.setProperty('display', 'none', 'important');
                }
            }
        }
        
        console.log('‚úÖ Token Creator Script Loaded Successfully!');
        console.log('connectWallet function exists:', typeof connectWallet);
    </script>
    <script src="js/chain-selector.js"></script>
</body>
</html>
